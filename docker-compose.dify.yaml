name: dify
version: "3.9"

# Общий набор переменных для api/worker
x-dify-env: &dify_common_env
  # Режим и логирование
  DEPLOY_ENV: ${DEPLOY_ENV:-PRODUCTION}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  MIGRATION_ENABLED: ${MIGRATION_ENABLED:-true}
  SECRET_KEY: ${SECRET_KEY}

  # ---- PostgreSQL ----
  DB_USERNAME: ${DB_USERNAME}
  DB_PASSWORD: ${DB_PASSWORD}
  DB_HOST: ${DB_HOST:-db}
  DB_PORT: ${DB_PORT:-5432}
  DB_DATABASE: ${DB_DATABASE}

  # ---- Redis / Celery ----
  REDIS_HOST: ${REDIS_HOST:-redis}
  REDIS_PORT: ${REDIS_PORT:-6379}
  REDIS_DB: ${REDIS_DB:-0}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}

  # ---- Хранилище: S3 (MinIO) ----
  STORAGE_TYPE: s3
  S3_ENDPOINT: ${S3_ENDPOINT}          # например http://minio:9000
  S3_BUCKET_NAME: ${S3_BUCKET_NAME}
  S3_ACCESS_KEY: ${S3_ACCESS_KEY}
  S3_SECRET_KEY: ${S3_SECRET_KEY}
  S3_REGION: ${S3_REGION:-us-east-1}
  S3_USE_AWS_MANAGED_IAM: ${S3_USE_AWS_MANAGED_IAM:-false}
  S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-true}
  # (опц.) корневой URL для публичных ссылок на файлы
  FILES_URL: ${FILES_URL:-}

  # ---- Векторное хранилище: внешний Qdrant ----
  VECTOR_STORE: qdrant
  QDRANT_URL: ${QDRANT_URL}
  QDRANT_API_KEY: ${QDRANT_API_KEY:-}

  # ---- Sandbox ----
  CODE_EXECUTION_ENDPOINT: http://sandbox:8194
  CODE_EXECUTION_API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}

  # ---- Базовые URL (UI/Console/API) ----
  CONSOLE_API_URL: ${CONSOLE_API_URL:-http://localhost:5001}
  CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-http://localhost:3000}
  SERVICE_API_URL: ${SERVICE_API_URL:-http://localhost:5001}
  APP_API_URL: ${APP_API_URL:-http://localhost:5001}
  APP_WEB_URL: ${APP_WEB_URL:-http://localhost:3000}

  # ---- OpenAI-совместимый endpoint (ваш LiteLLM) ----
  OPENAI_API_BASE: ${OPENAI_API_BASE:-http://litellm:4000/v1}

services:
  db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO с автосозданием бакета через MINIO_DEFAULT_BUCKETS (Bitnami)
  minio:
    image: bitnami/minio:latest
    restart: unless-stopped
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY}
      MINIO_DEFAULT_BUCKETS: ${S3_BUCKET_NAME}:none
      # (опц.) если публикуете за прокси на домене, пропишите внешний URL:
      # MINIO_SERVER_URL: ${MINIO_SERVER_URL:-https://minio.example.com}
      # MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-https://minio-console.example.com}
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9000/minio/health/live > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5

  sandbox:
    image: langgenius/dify-sandbox:latest
    restart: unless-stopped
    environment:
      API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}
      GIN_MODE: ${SANDBOX_GIN_MODE:-release}
      WORKER_TIMEOUT: ${SANDBOX_WORKER_TIMEOUT:-15}
      ENABLE_NETWORK: ${SANDBOX_ENABLE_NETWORK:-true}
      # (опц.) прокси для SSRF-ограничения исходящих запросов
      # HTTP_PROXY: ${SANDBOX_HTTP_PROXY:-http://ssrf_proxy:3128}
      # HTTPS_PROXY: ${SANDBOX_HTTPS_PROXY:-http://ssrf_proxy:3128}
    ports:
      - "8194:8194"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8194/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    image: langgenius/dify-api:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
      - minio
      - sandbox
    environment:
      MODE: api
      <<: *dify_common_env
    ports:
      - "5001:5001"

  worker:
    image: langgenius/dify-api:latest
    restart: unless-stopped
    depends_on:
      - db
      - redis
      - minio
      - sandbox
    environment:
      MODE: worker
      <<: *dify_common_env

  web:
    image: langgenius/dify-web:latest
    restart: unless-stopped
    depends_on:
      - api
    environment:
      # переменные фронта (важно, иначе UI может «прилипать» к 127.0.0.1)
      CONSOLE_API_URL: ${CONSOLE_API_URL:-http://localhost:5001}
      APP_API_URL: ${APP_API_URL:-http://localhost:5001}
      # для совместимости со старыми сборками
      CONSOLE_URL: ${CONSOLE_API_URL:-http://localhost:5001}
      APP_URL: ${APP_API_URL:-http://localhost:5001}
    ports:
      - "3000:3000"

volumes:
  db-data:
  redis-data:
  minio-data:
